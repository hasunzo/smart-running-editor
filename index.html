<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏃‍♂️ 스마트 러닝 인증샷 에디터</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.8em;
            text-align: center;
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-box {
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-box:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-box.uploaded {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .upload-box input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-text {
            font-size: 1.1em;
            color: #666;
            margin-top: 10px;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .preview-card {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .preview-card img {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
        }

        .controls-section {
            margin: 25px 0;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .control-group select, .control-group button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .control-group select:focus, .control-group button:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin: 10px 5px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .canvas-container {
            text-align: center;
            position: relative;
        }

        .canvas-wrapper {
            display: inline-block;
            border: 2px solid #ddd;
            border-radius: 15px;
            overflow: hidden;
            background: #f0f0f0;
            max-width: 100%;
        }

        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-error {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 10px;
            }
            
            .panel {
                padding: 20px;
            }
            
            body {
                padding: 10px;
            }
            
            .upload-box {
                padding: 30px 15px;
                min-height: 120px;
            }
        }

        .crop-mode-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 왼쪽 패널: 업로드 및 설정 -->
        <div class="panel">
            <h2>🏃‍♂️ 스마트 러닝 인증샷 에디터</h2>
            
            <!-- 배경 이미지 업로드 -->
            <div class="upload-section">
                <h3>📸 배경 러닝 사진</h3>
                <div class="upload-box" id="backgroundUpload">
                    <div class="upload-icon">🌄</div>
                    <div class="upload-text">배경 러닝 사진을 드래그하거나 클릭해주세요</div>
                    <input type="file" id="backgroundFile" accept="image/*">
                </div>
                <div class="preview-card" id="backgroundPreview">
                    <img id="backgroundImg" alt="배경 미리보기">
                </div>
            </div>

            <!-- 러닝 기록 스크린샷 업로드 -->
            <div class="upload-section">
                <h3>📱 러닝 기록 스크린샷</h3>
                <div class="upload-box" id="statsUpload">
                    <div class="upload-icon">📊</div>
                    <div class="upload-text">러닝 기록 스크린샷을 드래그하거나 클릭해주세요</div>
                    <input type="file" id="statsFile" accept="image/*">
                </div>
                <div class="preview-card" id="statsPreview">
                    <img id="statsImg" alt="기록 미리보기">
                </div>
            </div>

            <!-- 설정 섹션 -->
            <div class="controls-section">
                <div class="control-group">
                    <label for="cropMode">🎯 크롭핑 모드</label>
                    <select id="cropMode">
                        <option value="auto">자동 감지 (AI 추천)</option>
                        <option value="manual">수동 크롭</option>
                        <option value="full">전체 사용</option>
                    </select>
                    <div class="crop-mode-info" id="cropModeInfo">
                        AI가 러닝 기록 영역을 자동으로 감지합니다
                    </div>
                </div>

                <div class="control-group">
                    <label for="textColor">✨ 글자 색상 모드</label>
                    <select id="textColor">
                        <option value="original">원본 색상 유지</option>
                        <option value="white">하얀색 글자</option>
                        <option value="shadow">아웃라인 효과</option>
                    </select>
                </div>

                <button class="btn-primary" id="processBtn" disabled>
                    🎨 합성하기
                </button>
                
                <button class="btn-primary" id="downloadBtn" disabled>
                    💾 다운로드
                </button>
            </div>

            <div id="statusMessage"></div>
        </div>

        <!-- 오른쪽 패널: 캔버스 -->
        <div class="panel">
            <h2>🎨 결과물 미리보기</h2>
            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <canvas id="fabricCanvas" width="600" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let fabric_canvas;
        let backgroundImageData = null;
        let statsImageData = null;
        let processedStatsImage = null;

        // Fabric.js 초기화 대기
        function waitForFabric() {
            return new Promise((resolve) => {
                if (typeof fabric !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(() => waitForFabric().then(resolve), 100);
                }
            });
        }

        // 초기화
        async function initialize() {
            await waitForFabric();
            
            fabric_canvas = new fabric.Canvas('fabricCanvas', {
                width: 600,
                height: 400,
                backgroundColor: '#f0f0f0'
            });

            setupEventListeners();
            updateCropModeInfo();
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 파일 업로드
            document.getElementById('backgroundFile').addEventListener('change', handleBackgroundUpload);
            document.getElementById('statsFile').addEventListener('change', handleStatsUpload);
            
            // 드래그 앤 드롭
            setupDragAndDrop('backgroundUpload', 'backgroundFile');
            setupDragAndDrop('statsUpload', 'statsFile');
            
            // 컨트롤
            document.getElementById('cropMode').addEventListener('change', updateCropModeInfo);
            document.getElementById('processBtn').addEventListener('click', processImages);
            document.getElementById('downloadBtn').addEventListener('click', downloadResult);
        }

        // 드래그 앤 드롭 설정
        function setupDragAndDrop(uploadBoxId, fileInputId) {
            const uploadBox = document.getElementById(uploadBoxId);
            const fileInput = document.getElementById(fileInputId);

            uploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadBox.style.borderColor = '#667eea';
            });

            uploadBox.addEventListener('dragleave', () => {
                uploadBox.style.borderColor = '#ccc';
            });

            uploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadBox.style.borderColor = '#ccc';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
        }

        // 배경 이미지 업로드 처리
        function handleBackgroundUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                backgroundImageData = event.target.result;
                
                const img = document.getElementById('backgroundImg');
                img.src = backgroundImageData;
                document.getElementById('backgroundPreview').style.display = 'block';
                document.getElementById('backgroundUpload').classList.add('uploaded');
                
                checkReadyToProcess();
                showStatus('배경 이미지가 업로드되었습니다! ✅', 'success');
            };
            reader.readAsDataURL(file);
        }

        // 러닝 기록 업로드 처리
        function handleStatsUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                statsImageData = event.target.result;
                
                const img = document.getElementById('statsImg');
                img.src = statsImageData;
                document.getElementById('statsPreview').style.display = 'block';
                document.getElementById('statsUpload').classList.add('uploaded');
                
                checkReadyToProcess();
                showStatus('러닝 기록 스크린샷이 업로드되었습니다! ✅', 'success');
            };
            reader.readAsDataURL(file);
        }

        // 처리 준비 상태 확인
        function checkReadyToProcess() {
            const processBtn = document.getElementById('processBtn');
            if (backgroundImageData && statsImageData) {
                processBtn.disabled = false;
                showStatus('모든 이미지가 준비되었습니다! 합성 버튼을 눌러주세요 🎨', 'success');
            }
        }

        // 크롭 모드 정보 업데이트
        function updateCropModeInfo() {
            const mode = document.getElementById('cropMode').value;
            const info = document.getElementById('cropModeInfo');
            
            const infoTexts = {
                'auto': 'AI가 러닝 기록 영역을 자동으로 감지합니다',
                'manual': '마우스로 직접 영역을 선택할 수 있습니다',
                'full': '스크린샷 전체를 그대로 사용합니다'
            };
            
            info.textContent = infoTexts[mode];
        }

        // 스마트 크롭핑 알고리즘
        function smartCropRunningStats(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            let minX = width, maxX = 0, minY = height, maxY = 0;
            let textPixels = [];
            
            // 텍스트/숫자 픽셀 감지 (brightness < 120)
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const idx = (y * width + x) * 4;
                    const r = data[idx];
                    const g = data[idx + 1];
                    const b = data[idx + 2];
                    const brightness = (r + g + b) / 3;
                    
                    if (brightness < 120) {
                        textPixels.push({x, y});
                        minX = Math.min(minX, x);
                        maxX = Math.max(maxX, x);
                        minY = Math.min(minY, y);
                        maxY = Math.max(maxY, y);
                    }
                }
            }
            
            // 상단 40% 영역의 큰 숫자들 우선 포함
            const topRegion = height * 0.4;
            const importantPixels = textPixels.filter(p => p.y < topRegion);
            
            if (importantPixels.length > 0) {
                const impMinY = Math.min(...importantPixels.map(p => p.y));
                minY = Math.min(minY, impMinY);
            }
            
            // 적절한 여백 추가 (10% 마진)
            const margin = Math.min(width, height) * 0.1;
            minX = Math.max(0, minX - margin);
            maxX = Math.min(width, maxX + margin);
            minY = Math.max(0, minY - margin);
            maxY = Math.min(height, maxY + margin);
            
            return {
                x: minX,
                y: minY,
                width: maxX - minX,
                height: maxY - minY
            };
        }

        // 고급 배경 제거 알고리즘
        function advancedRemoveBackground(ctx, width, height, colorMode) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            // 가장자리 픽셀로 배경색 자동 감지
            let bgR = 0, bgG = 0, bgB = 0;
            let edgePixelCount = 0;
            
            // 가장자리 20픽셀 샘플링
            const edgeSize = 20;
            for (let i = 0; i < edgeSize && i < width; i++) {
                for (let j = 0; j < edgeSize && j < height; j++) {
                    const positions = [
                        j * width + i,  // 왼쪽 위
                        j * width + (width - 1 - i),  // 오른쪽 위
                        (height - 1 - j) * width + i,  // 왼쪽 아래
                        (height - 1 - j) * width + (width - 1 - i)  // 오른쪽 아래
                    ];
                    
                    positions.forEach(pos => {
                        if (pos * 4 < data.length) {
                            bgR += data[pos * 4];
                            bgG += data[pos * 4 + 1];
                            bgB += data[pos * 4 + 2];
                            edgePixelCount++;
                        }
                    });
                }
            }
            
            bgR /= edgePixelCount;
            bgG /= edgePixelCount;
            bgB /= edgePixelCount;
            
            // 임계값 기반 배경/텍스트 구분
            const threshold = 40;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // 유클리드 거리로 배경 판단
                const distance = Math.sqrt(
                    Math.pow(r - bgR, 2) + 
                    Math.pow(g - bgG, 2) + 
                    Math.pow(b - bgB, 2)
                );
                
                if (distance < threshold) {
                    // 배경으로 판단 - 투명화
                    data[i + 3] = 0;
                } else {
                    // 텍스트로 판단 - 색상 모드 적용
                    switch (colorMode) {
                        case 'white':
                            data[i] = 255;      // R
                            data[i + 1] = 255;  // G
                            data[i + 2] = 255;  // B
                            data[i + 3] = 255;  // A
                            break;
                        case 'shadow':
                            // 흰 글자로 변환
                            data[i] = 255;
                            data[i + 1] = 255;
                            data[i + 2] = 255;
                            data[i + 3] = 255;
                            break;
                        case 'original':
                        default:
                            // 원본 색상 유지하면서 대비 강화
                            if (r + g + b < 300) {  // 어두운 색상인 경우
                                data[i] = Math.max(0, r - 20);
                                data[i + 1] = Math.max(0, g - 20);
                                data[i + 2] = Math.max(0, b - 20);
                            }
                            data[i + 3] = 255;
                            break;
                    }
                }
            }
            
            // 아웃라인 효과를 위한 추가 처리
            if (colorMode === 'shadow') {
                const shadowData = new Uint8ClampedArray(data);
                
                // 3x3 커널을 사용한 morphological 연산
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        
                        if (data[idx + 3] > 0) {  // 텍스트 픽셀인 경우
                            // 주변 8픽셀 검사
                            for (let dy = -1; dy <= 1; dy++) {
                                for (let dx = -1; dx <= 1; dx++) {
                                    const neighborIdx = ((y + dy) * width + (x + dx)) * 4;
                                    if (data[neighborIdx + 3] === 0) {  // 투명 픽셀 근처
                                        // 검은 아웃라인 추가
                                        shadowData[neighborIdx] = 0;      // R
                                        shadowData[neighborIdx + 1] = 0;  // G
                                        shadowData[neighborIdx + 2] = 0;  // B
                                        shadowData[neighborIdx + 3] = 180; // 반투명
                                    }
                                }
                            }
                        }
                    }
                }
                
                // 아웃라인 적용
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i + 3] === 0 && shadowData[i + 3] > 0) {
                        data[i] = shadowData[i];
                        data[i + 1] = shadowData[i + 1];
                        data[i + 2] = shadowData[i + 2];
                        data[i + 3] = shadowData[i + 3];
                    }
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        // 이미지 처리 메인 함수
        async function processImages() {
            if (!backgroundImageData || !statsImageData) return;
            
            showStatus('<div class="loading"></div>이미지를 처리하고 있습니다...', 'success');
            document.getElementById('processBtn').disabled = true;
            
            try {
                // 배경 이미지 로드
                const bgImg = await loadImage(backgroundImageData);
                
                // 러닝 기록 이미지 처리
                const statsImg = await loadImage(statsImageData);
                const processedStats = await processStatsImage(statsImg);
                
                // Fabric.js 캔버스에 합성
                await compositeImages(bgImg, processedStats);
                
                showStatus('이미지 합성이 완료되었습니다! 🎉', 'success');
                document.getElementById('downloadBtn').disabled = false;
                
            } catch (error) {
                console.error('처리 중 오류:', error);
                showStatus('이미지 처리 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
            } finally {
                document.getElementById('processBtn').disabled = false;
            }
        }

        // 이미지 로드 헬퍼
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        // 러닝 기록 이미지 처리
        async function processStatsImage(statsImg) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = statsImg.width;
            canvas.height = statsImg.height;
            ctx.drawImage(statsImg, 0, 0);
            
            const cropMode = document.getElementById('cropMode').value;
            const colorMode = document.getElementById('textColor').value;
            
            let cropArea = {
                x: 0,
                y: 0,
                width: canvas.width,
                height: canvas.height
            };
            
            // 크롭핑 모드에 따른 처리
            if (cropMode === 'auto') {
                cropArea = smartCropRunningStats(ctx, canvas.width, canvas.height);
            }
            
            // 크롭된 영역만 추출
            const croppedCanvas = document.createElement('canvas');
            const croppedCtx = croppedCanvas.getContext('2d');
            
            croppedCanvas.width = cropArea.width;
            croppedCanvas.height = cropArea.height;
            
            croppedCtx.drawImage(
                canvas,
                cropArea.x, cropArea.y, cropArea.width, cropArea.height,
                0, 0, cropArea.width, cropArea.height
            );
            
            // 배경 제거 및 색상 변경
            advancedRemoveBackground(croppedCtx, croppedCanvas.width, croppedCanvas.height, colorMode);
            
            // Fabric.js Image 객체로 변환
            return new Promise((resolve) => {
                fabric.Image.fromURL(croppedCanvas.toDataURL(), (img) => {
                    resolve(img);
                });
            });
        }

        // 이미지 합성
        async function compositeImages(bgImg, statsImg) {
            // 캔버스 크기를 배경 이미지에 맞게 조정
            const aspectRatio = bgImg.width / bgImg.height;
            let canvasWidth = 600;
            let canvasHeight = 600 / aspectRatio;
            
            if (canvasHeight > 400) {
                canvasHeight = 400;
                canvasWidth = 400 * aspectRatio;
            }
            
            fabric_canvas.setDimensions({
                width: canvasWidth,
                height: canvasHeight
            });
            
            // 기존 객체 제거
            fabric_canvas.clear();
            
            // 배경 이미지 추가
            const fabricBgImg = await new Promise((resolve) => {
                fabric.Image.fromURL(backgroundImageData, (img) => {
                    img.set({
                        left: 0,
                        top: 0,
                        scaleX: canvasWidth / bgImg.width,
                        scaleY: canvasHeight / bgImg.height,
                        selectable: false
                    });
                    resolve(img);
                });
            });
            
            fabric_canvas.add(fabricBgImg);
            
            // 러닝 기록 이미지 추가
            const maxStatsWidth = canvasWidth * 0.4;
            const scale = Math.min(maxStatsWidth / statsImg.width, 1);
            
            statsImg.set({
                left: canvasWidth * 0.05,
                top: canvasHeight * 0.05,
                scaleX: scale,
                scaleY: scale,
                shadow: new fabric.Shadow({
                    color: 'rgba(0,0,0,0.3)',
                    blur: 10,
                    offsetX: 3,
                    offsetY: 3
                })
            });
            
            fabric_canvas.add(statsImg);
            fabric_canvas.setActiveObject(statsImg);
            fabric_canvas.renderAll();
            
            processedStatsImage = statsImg;
        }

        // 다운로드 기능
        function downloadResult() {
            if (!fabric_canvas) return;
            
            // 선택 상태 해제
            fabric_canvas.discardActiveObject();
            fabric_canvas.renderAll();
            
            // 고품질 다운로드를 위한 임시 캔버스
            const downloadCanvas = document.createElement('canvas');
            const downloadCtx = downloadCanvas.getContext('2d');
            
            // 원본 해상도로 확대
            const scale = 2;
            downloadCanvas.width = fabric_canvas.width * scale;
            downloadCanvas.height = fabric_canvas.height * scale;
            
            downloadCtx.scale(scale, scale);
            downloadCtx.drawImage(fabric_canvas.lowerCanvasEl, 0, 0);
            
            // 다운로드
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '');
            link.download = `스마트_러닝_인증샷_${timestamp}.png`;
            link.href = downloadCanvas.toDataURL('image/png', 1.0);
            link.click();
            
            showStatus('이미지가 다운로드되었습니다! 📁', 'success');
        }

        // 상태 메시지 표시
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>